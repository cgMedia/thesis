\section{Formulation}

An incident electric field $\vb{E}_\text{inc}(\vb{r}, t)$ induces a source polarization distribution, $\vb{P}(\vb{r}, t)$, on a collection of objects (either discrete or continuous) embedded in a homogeneous background medium by way of an underlying linear~\cite{} or nonlinear~\cite{Glosser2017} process.
This current subsequently generates a secondary $\vb{E}_\text{scat}(\vb{r}, t) = \mathfrak{F}\qty{\vb{P}(\vb{r}, t)}$, thus the total field at any spacetime coordinate becomes
\begin{equation}
  \vb{E}(\vb{r}, t) = \vb{E}_\text{inc}(\vb{r}, t) + \mathfrak{F}\qty{\vb{P}(\vb{r}, t)}.
\end{equation}
Assuming $\vb{E}(\vb{r}, t)$ consists of a low-frequency envelope modulated by a high-frequency sinusoid, i.e. $\vb{E}(\vb{r}, t) = \tilde{\vb{E}}(\vb{r}, t) e^{i \omega_L t}$, we can suppress the $e^{i \omega_L t}$ term in favor of an assumed spatial phase factor.
Thus,
\begin{equation}
  \tilde{\vb{E}}(\vb{r}, t) = \tilde{\vb{E}}_\text{inc}(\vb{r}, t) + \tilde{\mathfrak{F}}\qty{\tilde{\vb{P}}(\vb{r}, t)}
\end{equation}
where tildes on field variables denote envelope functions.
By enforcing radiation boundary conditions (namely that $\vb{E}_\text{scat}(\vb{r}, t) \to 0$ as $\abs{\vb{r}} \to \infty$), Maxwell's equations require
\begin{equation}
  \mathfrak{F}\qty{\vb{P}(\vb{r}, t)} = -\frac{\mu}{4\pi} \siint \frac{\delta(t_R - t')}{\abs{\vb{r} - \vb{r}'}} \qty(\pdv[2]{{t'}} - c^2 \grad' \grad'\boldsymbol{\cdot}) \vb{P}(\vb{r}', t') \dd[1]{t'} \dd[3]{\vb{r}'}
  \label{eq:efie}
\end{equation}
where $\mu$ characterizes the permeability of the background medium and $t_R \equiv t - \abs{\vb{r} - \vb{r}'}/c$ (see \cref{appendix:vector wave equation}).
Accordingly,
\begin{equation}
  \tilde{\mathfrak{F}}\qty{\tilde{\vb{P}}(\vb{r}, t)}e^{i \omega_L t} = -\frac{\mu}{4\pi} \siint \frac{\delta(t_R - t')}{\abs{\vb{r} - \vb{r}'}} \qty(\pdv[2]{{t'}} - c^2 \grad' \grad'\boldsymbol{\cdot}) \tilde{\vb{P}}(\vb{r}', t') e^{i \omega_L t'} \dd[1]{t'} \dd[3]{\vb{r}'}
  \label{eq:efie envelope}
\end{equation}
and, after performing the temporal integration and suppressing the $e^{i \omega_L t}$ factor on both sides of the equation, we have
\begin{equation}
  \tilde{\mathfrak{F}}\qty{\tilde{\vb{P}}(\vb{r}, t)} = -\frac{\mu}{4\pi} \sint \frac{e^{- i \omega_L \abs{\vb{r} - \vb{r}'}}}{\abs{\vb{r} - \vb{r}'}} \qty(\pdv[2]{t} + 2 i \omega_L \pdv{t} - \omega_L^2 - c^2 \grad' \grad'\boldsymbol{\cdot}) \tilde{\vb{P}}(\vb{r}', t_R) \dd[3]{\vb{r}'}.
  \label{eq:efie envelope}
\end{equation}
(We note that $\partial_{t_R} = \partial_{t}$ and that \cref{eq:efie envelope} recovers \cref{eq:efie} in the limit of $\omega_L \to 0$.)

To effect the calculation of \cref{eq:efie envelope} on bounded geometries of interest, we represent $\tilde{\vb{P}}(\vb{r}, t)$ as a collection of spatio-temporal basis functions,
\begin{equation}
  \tilde{\vb{P}}(\vb{r}, t) \approx \sum_{\ell = 0}^{N_s - 1} \sum_{m = 0}^{N_t - 1} \tilde{\mathcal{A}}_\ell^{(m)} \vb{s}_\ell(\vb{r}) T(t - m \, \Delta t).
  \label{eq:discretization}
\end{equation}
Conventionally, $\Delta t^{-1} \propto \omega_\text{max}$---the highest frequency in the system.
By formulating the problem in terms of envelope functions, however, we may choose $\Delta t$ proportional to the bandwidth of the envelopes.
In narrowband applications that evade a frequency-domain analysis---such as those with nonlinear (semiclassical) trappings---this can allow a $\Delta t$ several orders of magnitude larger than in conventional simulations.
This envelope shifting approach does not work equally well in space, however; due to the presence of the $e^{i \omega_L \abs{\vb{r} - \vb{r}'}/c}$ factor in \cref{eq:efie envelope}, interference phenomena still occur on the scale of $\omega_L/c$ (i.e. at a high spatial frequency), thus we still require sub-wavelength spatial discretizations.
Finally, we require both $\vb{s}_\ell(\vb{r})$ and $T(t)$ to have finite support, and $T(t)$ must accurately interpolate derivatives of order $0 \leqslant d \leqslant 2$ to capture the full dynamics of \cref{eq:efie envelope}.

Substituting \cref{eq:discretization} into \cref{eq:efie envelope} and projecting onto the same set of $\vb{s}_\ell(\vb{r})$ produces a spatially-blocked matrix equation of the form
\begin{equation}
  \begin{aligned}
    \tilde{\mathcal{F}}^{(m)} &= \tilde{\mathcal{L}}^{(m)} + \sum_{m'= 0}^m \tilde{\mathcal{Z}}^{(m - m')} \tilde{\mathcal{A}}^{(m')} \\
  \end{aligned}
  \label{eq:mot}
\end{equation}
where
\begin{subequations}
  \begin{align}
    \tilde{\mathcal{F}}^{(m)}_\ell &= \langle \vb{s}_\ell(\vb{r}), \tilde{\vb{E}}(\vb{r}, m \, \Delta t) \rangle \label{eq:f elements}\\
    \tilde{\mathcal{L}}^{(m)}_\ell &= \langle \vb{s}_\ell(\vb{r}), \tilde{\vb{E}}_\text{inc}(\vb{r}, m \, \Delta t) \rangle \label{eq:l elements}\\
    \tilde{\mathcal{Z}}^{(k)}_{\ell\ell'} &= \langle \vb{s}_\ell(\vb{r}), \tilde{\mathfrak{F}}\qty{\vb{s}_{\ell'}(\vb{r}, T(k \, \Delta t)} \rangle \label{eq:z elements}.
  \end{align}
\end{subequations}

For finite systems, only $\tilde{\mathcal{Z}}^{(0)}$ through $\tilde{\mathcal{Z}}^{(N_d)}$ contain nonzero elements, corresponding to the $N_d$ timesteps required to traverse the system completely.
Immediately, this bands $\tilde{\mathcal{Z}}$ to reduce the complexity of the sum in \cref{eq:mot} though the $\mathcal{O}(N_s^2)$ spatial complexity still dominates the overall computational cost.
Consequently, we draw inspiration from FFT-based techniques such as the Adaptive Integral Method (AIM)~\cite{Bleszynski1996,Yilmaz2004}, Conjugate Gradient FFT (CG-FFT)~\cite{CG-FFT}, and Particle-Particle Particle-Mesh (P$^3$M)~\cite{p cubed m} to develop an accelerated methodology for evaluating \cref{eq:mot}.

\subsection{Auxiliary grids}

\begin{figure}
  \centering
  \includegraphics[width=0.4\textwidth]{figures/dist_mat_unsorted}
  \hspace{1cm}
  \includegraphics[width=0.4\textwidth]{figures/dist_mat_sorted}
  \caption{\label{fig:matrix structure} The Laplace-kernel interaction matrix between 1024 points in a unit cube appears to have very little structure (left).
    While we cannot fully order the points in three dimensions, we \emph{can} permute the matrix so as to give points within the same neighborhood adjacent indices.
    Points ordered thusly produce a diagonally-dominant interaction matrix with a hierarchical Toeplitz substructure (right).
    Such structures indicate portions of the matrix have very accurate low-rank approximations, offering the possibility of significant compression.
  }
\end{figure}

\begin{figure}
  \centering
  \input{figures/aim_terminology.tex}
  \caption{\label{fig:aim terminology} Illustration of an AIM box and the surrounding environment.
    All of the sources within a box (shown as the central shaded square) map to the same set of expansion points (shown as open circles) indexed relative to $\vb{r}_\text{box} = \floor{\vb{r}/s}$.
  }
\end{figure}

\begin{figure}
  \centering
  \conditionalFigureInput{figures/expansion-grid}
  \caption{\label{fig:expansion grid}Spatial expansion pattern for a two-dimensional system.
    An expansion of order $m$ requires $(m + 1)^3$ grid points.
    Moreover, increasing the expansion order incorporates new points in such a way as to keep $\vb{s}_\ell(\vb{r})$ as close to the center of the expansion region as possible.
  }
\end{figure}

\begin{figure}
  \centering
  \conditionalFigureInput{figures/nf_correction}
  \caption{\label{fig:nearfield correction}Expansions $A$ and $B$ overlap, but only box $B$ lies in the nearfield of box $C$.
    Consequently, we must track the $BC$ interaction (dashed line) independently of the FFT-based convolution so as to remove its high-error contribution to the total field.
  }
\end{figure}

To effect a sub-quadratic calculation of \cref{eq:mot}, we approximate $\tilde{\mathcal{Z}}^{(k)}$ as a sum of near- and far-field contributions.
The near-field matrix elements follow directly from \cref{eq:z elements}---sources within a prescribed distance threshold interact ``directly'' so as to avoid incurring large errors in potentials with singularities.
In contrast, the far-field matrix never explicitly arise.
Instead, we construct the far-field interaction matrices between auxiliary sources residing on a regular grid.
Such a procedure has two salient advantages: it compresses the interaction matrix to a reduced number of auxiliary unknowns and imposes a Toeplitz structure amenible to diagonalization with fast Fourier transforms (FFTs).

The original AIM scheme in~\cite{Bleszynski1996} embeds a scattering structure within an auxiliary rectangular grid.
By construction, the interaction matrix of a translationally-invariant propagator (such as \cref{eq:efie envelope}) on this grid will have a hierarchical (block) Toeplitz structure.
This structure affords a very efficient matrix multiplication: as this matrix represents a discrete convolution, a multidimensional FFT diagonalizes the entire matrix in $\mathcal{O}(n \log n)$ steps.

Effecting this calculation for arbitrary structures requires one additional step, however.
As structures do not, in general, reside on structured grids, we require

\begin{enumerate}
  \item \textbf{Projection:} At time $m \, \Delta t$, we project the $\tilde{\mathcal{A}}^{(m)}_\ell \vb{s}_\ell(\vb{r})$ quantities onto a collection of spatial $\delta$-functions (the exterior grid).
    The number expansion points for each $\vb{s}_\ell(\vb{r})$ depends on the number of multipole moments required to recover the potential to a prescribed accuracy at a given distance away from $\vb{s}_\ell(\vb{r})$.
  \item \textbf{Propagation:}
  \item \textbf{Back-projection:}
  \item \textbf{Correction:}
  \item \textbf{Interpolation:}
\end{enumerate}

\section{Moment-matching}

To facillitate FFT-based matrix-vector products, we represent the primary $\vb{s}_\ell(\vb{r})$ basis functions as a weighted sum of $\delta$-functions on the surrounding gridpoints, i.e.
\begin{equation}
  \psi_\ell(\vb{r}) \approx \sum_{\vb{u} \in B_{\ell}} \Lambda_{\ell\vb{u}} \delta(\vb{r} - \vb{u}).
  \label{eq:grid linear combination}
\end{equation}
Here, $\psi_\ell(\vb{r}) \in \qty{\vb{s}_\ell(\vb{r})\cdot \vu{x}, \vb{s}_\ell(\vb{r}) \cdot \vu{y}, \vb{s}_\ell(\vb{r}) \cdot \vu{z}}$ and $B_\ell$ denotes the collection of grid points, $\vb{u}$, within the expansion region of $\vb{s}_\ell(\vb{r})$.
For an expansion of order\footnote{In principle, one could expand to different orders in different cartesian directions, though this involves considerably more bookkeeping for relatively little benefit. Thus, for convenience, we take ``the expansion order'' to mean the expansion order in every direction.} $m$, this sum contains $(m + 1)^3$ terms corresponding to the $(m + 1)^3$ grid points nearest to $\vb{s}_\ell(\vb{r})$.
Consequently, the $\Lambda_{\ell \vb{u}}$ matrices contain few nonzero elements and we have elected to use a moment-matching scheme to capture the $(m + 1)^3$ multipole moments of $\vb{s}_\ell(\vb{r})$ according to
\begin{equation}
  \sint (x - x_0)^{m_x}(y - y_0)^{m_y}(z - z_0)^{m_z} \qty[\psi_\ell(\vb{r}) - \sum_{\vb{u} \in c_\ell}\Lambda_{\ell\vb{u}}\delta(\vb{r} - \vb{u})] \dd[3]{\vb{r}} = 0.
  \label{eq:moment matching}
\end{equation}
In this expression, $0 \leqslant m_x, m_y, m_z \leqslant m$ and $\vb{r}_0 \equiv x_0 \vu{x} + y_0 \vu{y} + z_0\vu{z}$ denotes the origin about which we compute the multipoles.
Thus, to calculate the $\Lambda_{\ell \vb{u}}$, we solve the least-squares system,
\begin{equation}
  \sum_{\vb{u} \in B_\ell} W_{\vb{m}\vb{u}}\Lambda_{\ell\vb{u}} = Q_{\ell\vb{m}},
  \label{eq:expansion matrix system}
\end{equation}
where
\begin{subequations}
  \begin{align}
    W_{\vb{m}\vb{u}} &= (u_x - x_0)^{m_x} (u_y - y_0)^{m_y} (u_z - z_0)^{m_z} \label{eq:w matrix} \\
    Q_{\ell \vb{m}} &= \int_{} \psi_\ell(\vb{r}) (x - x_0)^{m_x} (y - y_0)^{m_y} (z - z_0)^{m_z} \dd[3]{\vb{r}} \label{eq:q vector}.
  \end{align}
\end{subequations}
With infinite precision, the choice of $\vb{r}_0$ merely sets a reference point for the multipole coordinate system; to minimize numerical issues, however, we choose $\vb{r}_0$ at the center of $\vb{s}_\ell(\vb{r})$.
As the primary basis functions consist entirely of $\delta$-functions, $\vb{r}_0 = \vb{r}$ and $Q_{\ell\vb{m}} = 0$ everywhere except for $Q_{\ell \vb{0}} \equiv 1$.


\subsection{Spatial analysis}

Consider two point particles located at $x_\text{src}$ and $x_\text{obs}$.
A time-independent Green's function, $g(x_\text{obs} - x_\text{src})$, describes the interaction between the two particles and we wish to construct a polynomial approximation of $g(x - x_\text{src})$ for $x$ in the vicinity of $x_\text{obs}$ as in \cref{fig:1d moments}.

To construct an interpolation polynomial over the expansion region of order $M$, we define a polynomial coordinate $x_p$ in units of $h$ such that $x_p^\text{min} \leqslant x_p \leqslant x_p^\text{min} + M$ where $x_p^\text{min} \equiv -\floor*{M/2}$.
Consequently, the expansion points about $x_\text{obs}$ correspond to $x_p \in \{-\floor*{M/2}$, $-\floor*{M/2} + 1$, $-\floor*{M/2} + 2$, $\ldots\}$ with the \nth{0} order expansion point, $x_0$, equivalent to $x_p = 0$.
Such a coordinate system defines the Vandermonde linear equation $\sum_{j}V_{ij} w_j = g_i$ for the weights of an interpolating polynomial\footnote{In principle this analysis works equally well in the original $(x_\text{src}, x_\text{obs})$ coordinate system. The polynomial coordinate has three advantages, however: it indexes the expansion points ``logically'' from left to right, $x_p^\text{min} \in \mathbb{Z}$ and thus the Vandermonde matrix has infinite precision, and it makes the interpolation error in terms of $h$ explicit.}~\cite{NumericalRecipes} where
\begin{subequations}
  \begin{align}
    V_{ij} &= (x_p^\text{min} + i)^j \\
    g_i &= g\qty((x_0 - x_\text{src}) + h(x_p^\text{min} + i))
  \end{align}
\end{subequations}
and $0 \leqslant i, j \leqslant M$.
Approximating $g(x - x_\text{src})$ at $x_\text{obs}$ then becomes a matter of evaluating this polynomial at $x_p = \qty(x_\text{obs} - x_0)/h$, i.e.
\begin{equation}
  g(x_\text{obs} - x_\text{src}) \approx \sum_{i = 0}^{M} w_i \qty(\frac{x_\text{obs} - x_0}{h})^i.
\end{equation}
Accordingly, the polynomial approximation to $g(x_\text{obs} - x_\text{src})$ contains terms of order $\mathcal{O}(h^{-M})$ and we can expect the approximation error to scale as $\mathcal{O}(h^{-(M + 1)})$ as demonstrated in \cref{fig:grid convergence}.
This also motivates using the approximation to calculate interactions involving differential operators; applying an $n^\text{th}$-order derivative reduces the polynomial order by $n$, thus the error scales like $\mathcal{O}(h^{-(M + 1) + n})$.

\begin{figure}
  \centering
  \input{figures/1d_moments}
  \caption{\label{fig:1d moments} Polynomial interpolation of $g(x - x_\text{src})$ near $x_\text{obs}$.
    Here, the green curve represents the actual $g(x - x_\text{src})$ and the dashed black line its approximation.
    Evaluating the $n^\text{th}$-order approximation requires knowledge of the signal at $n + 1$ grid points surrounding $x_\text{obs}$.
  }
\end{figure}

\begin{figure}
  \centering
  \input{figures/grid_spacing_error}
  \caption{\label{fig:grid convergence} $\ell_2$ error calculation of $g(\vb{r} - \vb{r}') = e^{i k \abs{\vb{r} - \vb{r}'}}/{\abs{\vb{r} - \vb{r}'}}$ for expansion orders zero through four.
    For each of the points above, a source and observation box separated by $\Delta \vb{r} = 10\lambda \vu{x} + 10 \lambda \vu{y} + 10 \lambda \vu{z}$ each contain 64 randomly placed points, thus the points within each box all map to identical nodes in the auxiliary grid.
    The moment-matching expansion scheme dictates that the overall error for an expansion of order $m$ scales as $\mathcal{O}(h^{m + 1})$.
  }
\end{figure}

\begin{figure}
  \centering
  \input{figures/nf_pair.tex}
  \caption{\label{fig:nearfield criterion}Illustration of the nearfield criterion for a third order expansion.
    The dashed line indicates the complete nearfield of the box associated with \textcolor{cbblue}{$\vb{r}_0$}---i.e. all boxes that have an expansion point within $\Delta s$ of the expansion around \textcolor{cbblue}{$\vb{r}_0$}.
  }
\end{figure}

