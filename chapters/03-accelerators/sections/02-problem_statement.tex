\section{Formulation}

\begin{figure}
  \centering
  \input{figures/aim_terminology.tex}
  \caption{\label{fig:aim terminology} Illustration of a single box system.
    All of the particles within a box (shown as the dark shaded square) map to the same set of expansion points (shown as open circles) indexed relative to $\vb{r}_\text{box} = \floor{\vb{r}/h}$.
  }
\end{figure}

The underlying mechanics remain effectively unchanged from \cref{ch:quantum dots}: a collection of $N_s$ pointlike \qds{} evolve due to incident electric field via \cref{eq:liouville}, implicitly coupled by way of secondary radiated fields.
Under the rotating-wave approximation~\cref{Allen1975}, the off-diagonal elements of a given \qd's density matrix, $\tilde{\rho}$, directly characterize the (complex-valued) polarization density of the \qd{} ($\tilde{\vb{P}}$).
This polarization density, then, acts as a source in Maxwell's equations to produce
\begin{equation}
  \tilde{\mathfrak{f}}\qty{\tilde{\vb{p}}(\vb{r}, t)}e^{i \omega_l t} = -\frac{\mu_0}{4\pi} \siint \frac{\delta(t - t'_r)}{\abs{\vb{r} - \vb{r}'}} \qty(\pdv[2]{t} - c^2 \grad' \grad'\boldsymbol{\cdot}) \tilde{\vb{p}}(\vb{r}', t') e^{i \omega_l t'} \dd[1]{t'} \dd[3]{\vb{r}'}
  \label{eq:envelope propagator}
\end{equation}
(see \cref{appendix:vector wave equation}).
This form of \cref{eq:radiated envelope} has several advantages in developing accelerated calculation schemes which we shall detail later.
Representing $\tilde{\vb{p}}(\vb{r}, t)$ as a collection of spatio-temporal basis functions,
\begin{equation}
  \tilde{\vb{p}}(\vb{r}, t) = \sum_{\ell = 0}^{n_s - 1} \sum_{m = 0}^{n_t - 1} \tilde{\mathcal{a}}_\ell^{(m)} \vb{s}_\ell(\vb{r}) t(t - m \, \delta t),
\end{equation}
we have again chosen $\vb{s}_\ell(\vb{r}) = \vb{d}_\ell \delta(\vb{r} - \vb{r}_\ell)$ and $t(t)$ as the standard Lagrange polynomial basis set.
Additionally, AIM embeds $\tilde{\vb{p}}(\vb{r}, t)$ within a cartesian grid with spacings chosen to sufficiently resolve the interference phenomena of \emph{unshifted}, fixed-frame sources.
This grid allows for the construction of auxilliary sources at each gridpoint, chosen so as to accurately reproduce fields eminating from the primary source at large distances.
As a result, interactions between gridpoints have a toeplitz matrix structure due to the translational invariance in $g(\vb{r} - \vb{r}')$ which facilitates rapid diagonalization via $n$-dimensional fast fourier transforms.
In total, the accelerated far-field calculation then proceeds via
\begin{inparaenum}[(i)]
  \item projecting the primary sources onto a collection of auxilliary point sources located at nodes of a regular cartesian grid,
  \item propagating fields between gridpoints with an accelerated matrix-vector product (done through multidimensional ffts),
  \item projecting the auxilliary sources back onto the primary sources.
\end{inparaenum}

\subsection{Building auxiliary sources}

\begin{figure}
  \centering
  \conditionalFigureInput{figures/expansion-grid}
  \caption{\label{fig:expansion grid}Spatial expansion pattern for a two-dimensional system.
    Increasing the expansion order incorporates new grid points in such a way as to keep $\vb{s}_\ell(\vb{r})$ as close to the center of the box as possible.
  }
\end{figure}

To facillitate fft-based matrix-vector products, we represent the primary basis functions as a weighted sum of $\delta$-functions on the surrounding gridpoints, i.e.
\begin{equation}
  \psi_\ell(\vb{r}) \approx \sum_{\vb{u} \in c_{\ell}} \lambda_{\ell\vb{u}} \delta(\vb{r} - \vb{u}).
  \label{eq:grid linear combination}
\end{equation}
Here, $\psi_\ell(\vb{r}) \in \qty{\vb{s}_\ell(\vb{r})\cdot \vu{x}, \vb{s}_\ell(\vb{r}) \cdot \vu{y}, \vb{s}_\ell(\vb{r}) \cdot \vu{z}}$ and $c_\ell$ denotes the collection of grid points, $\vb{u}$, within the expansion region of $\vb{s}_\ell(\vb{r})$.
For an expansion of order\footnote{in principle, one could expand to different orders in different cartesian directions, though this involves considerably more bookkeeping for relatively little benefit. thus, for convenience, we take ``the expansion order'' to mean the expansion order in every direction.} $m$, this sum contains $(m + 1)^3$ terms corresponding to the $(m + 1)^3$ grid points nearest to $\vb{s}_\ell(\vb{r})$.
Consequently, the $\lambda_{\ell \vb{u}}$ matrices contain few nonzero elements and we have elected to use a moment-matching scheme to capture the $(m + 1)^3$ multipole moments of $\vb{s}_\ell(\vb{r})$ according to
\begin{equation}
  \sint (x - x_0)^{m_x}(y - y_0)^{m_y}(z - z_0)^{m_z} \qty[\psi_\ell(\vb{r}) - \sum_{\vb{u} \in c_\ell}\lambda_{\ell\vb{u}}\delta(\vb{r} - \vb{u})] \dd[3]{\vb{r}} = 0.
  \label{eq:moment matching}
\end{equation}
In this expression, $0 \leqslant m_x, m_y, m_z \leqslant m$ and $\vb{r}_0 \equiv x_0 \vu{x} + y_0 \vu{y} + z_0\vu{z}$ denotes the origin about which we compute the multipoles.
Thus, to calculate the $\lambda_{\ell \vb{u}}$, we solve the least-squares system,
\begin{equation}
  \sum_{\vb{u} \in c_\ell} w_{\vb{m}\vb{u}}\lambda_{\ell\vb{u}} = q_{\ell\vb{m}},
  \label{eq:expansion matrix system}
\end{equation}
where
\begin{subequations}
  \begin{align}
    q_{\ell \vb{m}} &= \int_{} \psi_\ell(\vb{r}) (x - x_0)^{m_x} (y - y_0)^{m_y} (z - z_0)^{m_z} \dd[3]{\vb{r}} \label{eq:q vector}\\
    w_{\vb{m}\vb{u}} &= (u_x - x_0)^{m_x} (u_y - y_0)^{m_y} (u_z - z_0)^{m_z} \label{eq:w matrix}.
  \end{align}
\end{subequations}
With infinite precision, the choice of $\vb{r}_0$ merely sets a reference point for the multipole coordinate system; to minimize numerical issues, however, we take $\vb{r}_0 = \vb{r}$.
As the primary basis functions consist entirely of $\delta$-functions, $q_{\ell\vb{m}} = 0$ everywhere except for $q_{\ell \vb{0}} \equiv 1$.

\textcolor{red}{not sure how to link basis functions to derivatives yet---probably needs some description of matrix elements.}

Additionally, these expansions prove useful in calculating the $\grad' \grad' \boldsymbol{\cdot}$ terms of \cref{eq:envelope propagator}.
Using the definition of \cref{eq:q vector} we may compute additional collections of expansion coefficients corresponding to arbitrary derivatives in $x$, $y$, and $z$.
In doing so, we need only propagate $\tilde{\vb{p}}(\vb{r}, t)e^{-i \omega_l \abs{\vb{r} - \vb{r}'}}/\abs{\vb{r} - \vb{r}'}$ between gridpoints; the final projection operation off the auxilliary grid reconstructs the total field.
Moreover, we use the time history of the auxilliary sources alongside \cref{eq:q vector} (with familliar derivatives of Lagrange interpolants) to reconstruct the time-differentiated component of \cref{eq:envelope propagator}.
Because the inter-grid communication step bottlenecks the whole process, this expansion scheme requires propagation of only three quantities corresponding to the cartesian components of the vector sources in the expensive step of the calculation instead of having to propagate the three components of $\partial_t^2 \tilde{\vb{p}}$ and nine components of $\grad \grad \boldsymbol{\cdot} \tilde{\vb{p}}$ independently.

\section{Moment-matching}

\subsection{Spatial analysis}

Consider two point particles located at $x_\text{src}$ and $x_\text{obs}$. 
A time-independent Green's function, $g(x_\text{obs} - x_\text{src})$, describes the interaction between the two particles and we wish to construct a polynomial approximation of $g(x - x_\text{src})$ for $x$ in the vicinity of $x_\text{obs}$ as in \cref{fig:1d moments}.

To construct an interpolation polynomial over the expansion region of order $M$, we define a polynomial coordinate $x_p$ in units of $h$ such that $x_p^\text{min} \leqslant x_p \leqslant x_p^\text{min} + M$ where $x_p^\text{min} \equiv -\floor*{M/2}$.
Consequently, the expansion points about $x_\text{obs}$ correspond to $x_p \in \{-\floor*{M/2}$, $-\floor*{M/2} + 1$, $-\floor*{M/2} + 2$, $\ldots\}$ with the \nth{0} order expansion point, $x_0$, equivalent to $x_p = 0$.
Such a coordinate system defines the Vandermonde linear equation $\sum_{j}V_{ij} w_j = g_i$ for the weights of an interpolating polynomial\footnote{In principle this analysis works equally well in the original $(x_\text{src}, x_\text{obs})$ coordinate system. The polynomial coordinate has three advantages, however: it indexes the expansion points ``logically'' from left to right, $x_p^\text{min} \in \mathbb{Z}$ and thus the Vandermonde matrix has infinite precision, and it makes the interpolation error in terms of $h$ explicit.}~\cite{NumericalRecipes} where
\begin{subequations}
  \begin{align}
    V_{ij} &= (x_p^\text{min} + i)^j \\
    g_i &= g\qty((x_0 - x_\text{src}) + h(x_p^\text{min} + i))
  \end{align}
\end{subequations}
and $0 \leqslant i, j \leqslant M$.
Approximating $g(x - x_\text{src})$ at $x_\text{obs}$ then becomes a matter of evaluating this polynomial at $x_p = \qty(x_\text{obs} - x_0)/h$, i.e.
\begin{equation}
  g(x_\text{obs} - x_\text{src}) \approx \sum_{i = 0}^{M} w_i \qty(\frac{x_\text{obs} - x_0}{h})^i.
\end{equation}
Accordingly, the polynomial approximation to $g(x_\text{obs} - x_\text{src})$ contains terms of order $\mathcal{O}(h^{-M})$ and we can expect the approximation error to scale as $\mathcal{O}(h^{-(M + 1)})$ as demonstrated in \cref{fig:grid convergence}.
This also motivates using the approximation to calculate interactions involving differential operators; applying an $n^\text{th}$-order derivative reduces the polynomial order by $n$, thus the error scales like $\mathcal{O}(h^{-(M + 1) + n})$.

\begin{figure}
  \centering
  \input{figures/1d_moments}
  \caption{\label{fig:1d moments} Polynomial interpolation of $g(x - x_\text{src})$ near $x_\text{obs}$.
    Here, the green curve represents the actual $g(x - x_\text{src})$ and the dashed black line its approximation.
    Evaluating the $n^\text{th}$-order approximation requires knowledge of the signal at $n + 1$ grid points surrounding $x_\text{obs}$.
  }
\end{figure}

\begin{figure}
  \centering
  \input{figures/grid_spacing_error}
  \caption{\label{fig:grid convergence} $\ell_2$ error calculation of $g(\vb{r} - \vb{r}') = e^{i k \abs{\vb{r} - \vb{r}'}}/{\abs{\vb{r} - \vb{r}'}}$ for expansion orders zero through four.
    For each of the points above, a source and observation box separated by $\Delta \vb{r} = 10\lambda \vu{x} + 10 \lambda \vu{y} + 10 \lambda \vu{z}$ each contain 64 randomly placed points, thus the points within each box all map to identical nodes in the auxiliary grid. 
    The moment-matching expansion scheme dictates that the overall error for an expansion of order $m$ scales as $\mathcal{O}(h^{m + 1})$.
  }
\end{figure}

\begin{figure}
  \centering
  \input{figures/nf_pair.tex}
  \caption{\label{fig:nearfield criterion}Illustration of the nearfield criterion for a third order expansion in two dimensions.}
\end{figure}

\begin{figure}
  \centering
  \input{figures/nf_pair.tex}
  \caption{\label{fig:nearfield criterion}Illustration of the nearfield criterion for a third order expansion in two dimensions.}
\end{figure}
