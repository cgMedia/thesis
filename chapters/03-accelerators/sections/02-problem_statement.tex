\section{Formulation}

An incident electric field $\vb{E}_\text{inc}(\vb{r}, t)$ induces a source polarization distribution, $\vb{P}(\vb{r}, t)$, on a collection of objects (either discrete or continuous) embedded in a homogeneous background medium by way of an underlying linear~\cite{} or nonlinear~\cite{Glosser2017} process.
This current subsequently generates a secondary $\vb{E}_\text{scat}(\vb{r}, t) = \mathfrak{F}\qty{\vb{P}(\vb{r}, t)}$, thus the total field at any spacetime coordinate becomes
\begin{equation}
  \vb{E}(\vb{r}, t) = \vb{E}_\text{inc}(\vb{r}, t) + \mathfrak{F}\qty{\vb{P}(\vb{r}, t)}.
\end{equation}
Assuming $\vb{E}(\vb{r}, t)$ consists of a low-frequency envelope modulated by a high-frequency sinusoid, i.e. $\vb{E}(\vb{r}, t) = \tilde{\vb{E}}(\vb{r}, t) e^{i \omega_L t}$, we can suppress the $e^{i \omega_L t}$ term in favor of an assumed spatial phase factor. 
Thus,
\begin{equation}
  \tilde{\vb{E}}(\vb{r}, t) = \tilde{\vb{E}}_\text{inc}(\vb{r}, t) + \tilde{\mathfrak{F}}\qty{\tilde{\vb{P}}(\vb{r}, t)}
\end{equation}
where tildes on field variables denote envelope functions.
By enforcing radiation boundary conditions (namely that $\vb{E}_\text{scat}(\vb{r}, t) \to 0$ as $\abs{\vb{r}} \to \infty$), Maxwell's equations require
\begin{equation}
  \mathfrak{F}\qty{\vb{P}(\vb{r}, t)} = -\frac{\mu}{4\pi} \siint \frac{\delta(t_R - t')}{\abs{\vb{r} - \vb{r}'}} \qty(\pdv[2]{{t'}} - c^2 \grad' \grad'\boldsymbol{\cdot}) \vb{P}(\vb{r}', t') \dd[1]{t'} \dd[3]{\vb{r}'}
  \label{eq:efie}
\end{equation}
where $\mu$ characterizes the permeability of the background medium and $t_R \equiv t - \abs{\vb{r} - \vb{r}'}/c$ (see \cref{appendix:vector wave equation}).
Accordingly,
\begin{equation}
  \tilde{\mathfrak{F}}\qty{\tilde{\vb{P}}(\vb{r}, t)}e^{i \omega_L t} = -\frac{\mu}{4\pi} \siint \frac{\delta(t_R - t')}{\abs{\vb{r} - \vb{r}'}} \qty(\pdv[2]{{t'}} - c^2 \grad' \grad'\boldsymbol{\cdot}) \tilde{\vb{P}}(\vb{r}', t') e^{i \omega_L t'} \dd[1]{t'} \dd[3]{\vb{r}'}
  \label{eq:efie envelope}
\end{equation}
and, after performing the temporal integration and suppressing the $e^{i \omega_L t}$ factor on both sides of the equation, we have
\begin{equation}
  \tilde{\mathfrak{F}}\qty{\tilde{\vb{P}}(\vb{r}, t)} = -\frac{\mu}{4\pi} \sint \frac{e^{- i \omega_L \abs{\vb{r} - \vb{r}'}}}{\abs{\vb{r} - \vb{r}'}} \qty(\pdv[2]{t} + 2 i \omega_L \pdv{t} - \omega_L^2 - c^2 \grad' \grad'\boldsymbol{\cdot}) \tilde{\vb{P}}(\vb{r}', t_R) \dd[3]{\vb{r}'}.
  \label{eq:efie envelope}
\end{equation}
(We note that $\partial_{t_R} = \partial_{t}$ and that \cref{eq:efie envelope} recovers \cref{eq:efie} in the limit of $\omega_L \to 0$.)

To effect the calculation of \cref{eq:efie envelope} on bounded geometries of interest, we represent $\tilde{\vb{P}}(\vb{r}, t)$ as a collection of spatio-temporal basis functions,
\begin{equation}
  \tilde{\vb{P}}(\vb{r}, t) \approx \sum_{\ell = 0}^{N_s - 1} \sum_{m = 0}^{N_t - 1} \tilde{\mathcal{A}}_\ell^{(m)} \vb{s}_\ell(\vb{r}) T(t - m \, \Delta t).
  \label{eq:discretization}
\end{equation}
Conventionally, $\Delta t^{-1} \propto \omega_\text{max}$---the highest frequency in the system.
By formulating the problem in terms of envelope functions, however, we may choose $\Delta t$ proportional to the bandwidth of the envelopes.
In narrowband applications that evade a frequency-domain analysis---such as those with nonlinear (semiclassical) trappings---this can allow a $\Delta t$ several orders of magnitude larger than in conventional simulations.
This envelope shifting approach does not work equally well in space, however; due to the presence of the $e^{i \omega_L \abs{\vb{r} - \vb{r}'}/c}$ factor in \cref{eq:efie envelope}, interference phenomena still occur on the scale of $\omega_L/c$ (i.e. at a high spatial frequency), thus we still require sub-wavelength spatial discretizations.
Finally, we require both $\vb{s}_\ell(\vb{r})$ and $T(t)$ to have finite support, and $T(t)$ must accurately interpolate derivatives of order $0 \leqslant d \leqslant 2$ to capture the full dynamics of \cref{eq:efie envelope}.

\subsection{AIM propagation}

\begin{figure}
  \centering
  \conditionalFigureInput{figures/toeplitz_matrix}
  \caption{\label{fig:toeplitz}Illustration of the three-level (corresponding to three spatial dimensions) Toeplitz matrix structure for a $\abs{\vb{r} - \vb{r}'}^{-1}$ interaction kernel on a $5 \times 5 \times 5$ grid.
  As all of the unique elements lie along the first column, an FFT diagonalizes the ``circulant equivalent'' matrix (formed by mirroring appropriate elements/blocks) in $\mathcal{O}(3 n \log n)$ time.}
\end{figure}


\begin{figure}
  \centering
  \input{figures/aim_terminology.tex}
  \caption{\label{fig:aim terminology} Illustration of an AIM box and the surrounding environment.
    All of the sources within a box (shown as the central shaded square) map to the same set of expansion points (shown as open circles) indexed relative to $\vb{r}_\text{box} = \floor{\vb{r}/h}$.
  }
\end{figure}

\begin{figure}
  \centering
  \conditionalFigureInput{figures/expansion-grid}
  \caption{\label{fig:expansion grid}Spatial expansion pattern for a two-dimensional system.
    An expansion of order $m$ requires $(m + 1)^3$ grid points.
    Moreover, increasing the expansion order incorporates new points in such a way as to keep $\vb{s}_\ell(\vb{r})$ as close to the center of the box as possible.
  }
\end{figure}

\begin{figure}
  \centering
  \conditionalFigureInput{figures/nf_correction}
  \caption{\label{fig:nearfield correction}Expansions $A$ and $B$ overlap, but only box $B$ lies in the nearfield of box $C$.
    Consequently, we must track the $BC$ interaction independently of the FFT-based convolution so as to remove its high-error contribution to the total field.
  }
\end{figure}

To facillitate FFT-based matrix-vector products, we represent the primary $\vb{s}_\ell(\vb{r})$ basis functions as a weighted sum of $\delta$-functions on the surrounding gridpoints, i.e.
\begin{equation}
  \psi_\ell(\vb{r}) \approx \sum_{\vb{u} \in c_{\ell}} \lambda_{\ell\vb{u}} \delta(\vb{r} - \vb{u}).
  \label{eq:grid linear combination}
\end{equation}
Here, $\psi_\ell(\vb{r}) \in \qty{\vb{s}_\ell(\vb{r})\cdot \vu{x}, \vb{s}_\ell(\vb{r}) \cdot \vu{y}, \vb{s}_\ell(\vb{r}) \cdot \vu{z}}$ and $c_\ell$ denotes the collection of grid points, $\vb{u}$, within the expansion region of $\vb{s}_\ell(\vb{r})$.
For an expansion of order\footnote{In principle, one could expand to different orders in different cartesian directions, though this involves considerably more bookkeeping for relatively little benefit. Thus, for convenience, we take ``the expansion order'' to mean the expansion order in every direction.} $m$, this sum contains $(m + 1)^3$ terms corresponding to the $(m + 1)^3$ grid points nearest to $\vb{s}_\ell(\vb{r})$.
Consequently, the $\lambda_{\ell \vb{u}}$ matrices contain few nonzero elements and we have elected to use a moment-matching scheme to capture the $(m + 1)^3$ multipole moments of $\vb{s}_\ell(\vb{r})$ according to
\begin{equation}
  \sint (x - x_0)^{m_x}(y - y_0)^{m_y}(z - z_0)^{m_z} \qty[\psi_\ell(\vb{r}) - \sum_{\vb{u} \in c_\ell}\Lambda_{\ell\vb{u}}\delta(\vb{r} - \vb{u})] \dd[3]{\vb{r}} = 0.
  \label{eq:moment matching}
\end{equation}
In this expression, $0 \leqslant m_x, m_y, m_z \leqslant m$ and $\vb{r}_0 \equiv x_0 \vu{x} + y_0 \vu{y} + z_0\vu{z}$ denotes the origin about which we compute the multipoles.
Thus, to calculate the $\lambda_{\ell \vb{u}}$, we solve the least-squares system,
\begin{equation}
  \sum_{\vb{u} \in c_\ell} W_{\vb{m}\vb{u}}\Lambda_{\ell\vb{u}} = Q_{\ell\vb{m}},
  \label{eq:expansion matrix system}
\end{equation}
where
\begin{subequations}
  \begin{align}
    Q_{\ell \vb{m}} &= \int_{} \psi_\ell(\vb{r}) (x - x_0)^{m_x} (y - y_0)^{m_y} (z - z_0)^{m_z} \dd[3]{\vb{r}} \label{eq:q vector}\\
    W_{\vb{m}\vb{u}} &= (u_x - x_0)^{m_x} (u_y - y_0)^{m_y} (u_z - z_0)^{m_z} \label{eq:w matrix}.
  \end{align}
\end{subequations}
With infinite precision, the choice of $\vb{r}_0$ merely sets a reference point for the multipole coordinate system; to minimize numerical issues, however, we choose $\vb{r}_0$ at the center of $\vb{s}_\ell(\vb{r})$.
As the primary basis functions consist entirely of $\delta$-functions, $\vb{r}_0 = \vb{r}$ and $Q_{\ell\vb{m}} = 0$ everywhere except for $Q_{\ell \vb{0}} \equiv 1$.

\textcolor{red}{not sure how to link basis functions to derivatives yet---probably needs some description of matrix elements.}

Additionally, these expansions prove useful in calculating the $\grad' \grad' \boldsymbol{\cdot}$ terms of \cref{eq:envelope propagator}.
Using the definition of \cref{eq:q vector} we may compute additional collections of expansion coefficients corresponding to arbitrary derivatives in $x$, $y$, and $z$.
In doing so, we need only propagate $\tilde{\vb{P}}(\vb{r}, t)e^{-i \omega_l \abs{\vb{r} - \vb{r}'}}/\abs{\vb{r} - \vb{r}'}$ between gridpoints; the final projection operation off the auxilliary grid reconstructs the total field.
Moreover, we use the time history of the auxilliary sources alongside \cref{eq:q vector} (with familliar derivatives of Lagrange interpolants) to reconstruct the time-differentiated component of \cref{eq:envelope propagator}.
Because the inter-grid communication step bottlenecks the whole process, this expansion scheme requires propagation of only three quantities corresponding to the cartesian components of the vector sources in the expensive step of the calculation instead of having to propagate the three components of $\partial_t^2 \tilde{\vb{p}}$ and nine components of $\grad \grad \boldsymbol{\cdot} \tilde{\vb{p}}$ independently.

\section{Moment-matching}

\subsection{Spatial analysis}

Consider two point particles located at $x_\text{src}$ and $x_\text{obs}$. 
A time-independent Green's function, $g(x_\text{obs} - x_\text{src})$, describes the interaction between the two particles and we wish to construct a polynomial approximation of $g(x - x_\text{src})$ for $x$ in the vicinity of $x_\text{obs}$ as in \cref{fig:1d moments}.

To construct an interpolation polynomial over the expansion region of order $M$, we define a polynomial coordinate $x_p$ in units of $h$ such that $x_p^\text{min} \leqslant x_p \leqslant x_p^\text{min} + M$ where $x_p^\text{min} \equiv -\floor*{M/2}$.
Consequently, the expansion points about $x_\text{obs}$ correspond to $x_p \in \{-\floor*{M/2}$, $-\floor*{M/2} + 1$, $-\floor*{M/2} + 2$, $\ldots\}$ with the \nth{0} order expansion point, $x_0$, equivalent to $x_p = 0$.
Such a coordinate system defines the Vandermonde linear equation $\sum_{j}V_{ij} w_j = g_i$ for the weights of an interpolating polynomial\footnote{In principle this analysis works equally well in the original $(x_\text{src}, x_\text{obs})$ coordinate system. The polynomial coordinate has three advantages, however: it indexes the expansion points ``logically'' from left to right, $x_p^\text{min} \in \mathbb{Z}$ and thus the Vandermonde matrix has infinite precision, and it makes the interpolation error in terms of $h$ explicit.}~\cite{NumericalRecipes} where
\begin{subequations}
  \begin{align}
    V_{ij} &= (x_p^\text{min} + i)^j \\
    g_i &= g\qty((x_0 - x_\text{src}) + h(x_p^\text{min} + i))
  \end{align}
\end{subequations}
and $0 \leqslant i, j \leqslant M$.
Approximating $g(x - x_\text{src})$ at $x_\text{obs}$ then becomes a matter of evaluating this polynomial at $x_p = \qty(x_\text{obs} - x_0)/h$, i.e.
\begin{equation}
  g(x_\text{obs} - x_\text{src}) \approx \sum_{i = 0}^{M} w_i \qty(\frac{x_\text{obs} - x_0}{h})^i.
\end{equation}
Accordingly, the polynomial approximation to $g(x_\text{obs} - x_\text{src})$ contains terms of order $\mathcal{O}(h^{-M})$ and we can expect the approximation error to scale as $\mathcal{O}(h^{-(M + 1)})$ as demonstrated in \cref{fig:grid convergence}.
This also motivates using the approximation to calculate interactions involving differential operators; applying an $n^\text{th}$-order derivative reduces the polynomial order by $n$, thus the error scales like $\mathcal{O}(h^{-(M + 1) + n})$.

\begin{figure}
  \centering
  \input{figures/1d_moments}
  \caption{\label{fig:1d moments} Polynomial interpolation of $g(x - x_\text{src})$ near $x_\text{obs}$.
    Here, the green curve represents the actual $g(x - x_\text{src})$ and the dashed black line its approximation.
    Evaluating the $n^\text{th}$-order approximation requires knowledge of the signal at $n + 1$ grid points surrounding $x_\text{obs}$.
  }
\end{figure}

\begin{figure}
  \centering
  \input{figures/grid_spacing_error}
  \caption{\label{fig:grid convergence} $\ell_2$ error calculation of $g(\vb{r} - \vb{r}') = e^{i k \abs{\vb{r} - \vb{r}'}}/{\abs{\vb{r} - \vb{r}'}}$ for expansion orders zero through four.
    For each of the points above, a source and observation box separated by $\Delta \vb{r} = 10\lambda \vu{x} + 10 \lambda \vu{y} + 10 \lambda \vu{z}$ each contain 64 randomly placed points, thus the points within each box all map to identical nodes in the auxiliary grid. 
    The moment-matching expansion scheme dictates that the overall error for an expansion of order $m$ scales as $\mathcal{O}(h^{m + 1})$.
  }
\end{figure}

\begin{figure}
  \centering
  \input{figures/nf_pair.tex}
  \caption{\label{fig:nearfield criterion}Illustration of the nearfield criterion for a third order expansion.
    The dashed line indicates the complete nearfield of the box associated with \textcolor{cbblue}{$\vb{r}_0$}---i.e. all boxes that have an expansion point within $\Delta s$ of the expansion around \textcolor{cbblue}{$\vb{r}_0$}.
  }
\end{figure}

\section{Tensor polynomial interpolation}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \begin{axis}[cycle list/Blues-7, every axis plot/.append style={smooth}, domain=-1:1]
      \addplot {-1 + 18*x^2 - 48*x^4 + 32*x^6};
      \addplot {5*x - 20*x^3 + 16*x^5};
      \addplot {1 - 8*x^2 + 8*x^4};
      \addplot {-3*x + 4*x^3};
      \addplot {-1 + 2*x^2};
      \addplot {x};
      \addplot {1};
    \end{axis}
  \end{tikzpicture}
  \caption{\label{fig:chebyshev polynomials} Chebyshev polynomials $T_0(x)$ through $T_6(x)$.
    The roots of $T_{m + 1}(x)$ give the sample points for an interpolation scheme of order $m$ on the interval $\qty[-1, 1]$.
  }
\end{figure}

To facilitate accurate spatial derivatives of arbitrary order, 

\subsection{One dimension}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \begin{axis}[samples=128, every axis plot/.append style={smooth}, domain=-1:1, legend entries={$\qty(1 + 16x^2)^{-1/2}$, Lagrange, Chebyshev}]
      \addlegendimage{no markers, black}
      \addlegendimage{cbred, mark=*}
      \addlegendimage{cbblue, mark=diamond*, mark size=2}

      \addplot[black] {(1 + 16 * x^2)^-0.5};

      \pgfplotsset{cycle list shift=-1}
      \addplot {1. + x^2 * (-7.37712779012503 + x^2 * (53.87684354813709 + x^2 * (-228.0754143182082 + x^2 * (496.66170721466034 + x^2 * (-512.1411767023495 + 196.29770367292164 * x^2)))))};

      \addplot {1. + x^2 * (-6.528457748805862 + x^2 * (34.661982001110324 + x^2 * (-101.30878106137038 + x^2 * (156.3571608116639 + x^2 * (-119.85545125891753 + 35.924166950838185 * x^2)))))};

      \pgfplotsset{cycle list shift=-3}
      \addplot+[only marks] coordinates {
        (-1., 0.242536)
        (-0.833333, 0.287348)
        (-0.666667, 0.351123)
        (-0.5, 0.447214)
        (-0.333333, 0.6)
        (-0.166667, 0.83205)
        (0., 1.)
        (0.166667, 0.83205)
        (0.333333, 0.6)
        (0.5, 0.447214)
        (0.666667, 0.351123)
        (0.833333, 0.287348)
        (1., 0.242536)
      };
      \addplot+[only marks, mark=diamond*, mark size=2] coordinates {
        (0.992709, 0.244211)
        (0.935016, 0.258301)
        (0.822984,  0.290658)
        (0.663123, 0.352767)
        (0.464723, 0.473754)
        (0.239316,   0.722374)
        (0., 1.)
        (-0.239316, 0.722374)
        (-0.464723,   0.473754)
        (-0.663123, 0.352767)
        (-0.822984, 0.290658)
        (-0.935016,   0.258301)
        (-0.992709, 0.244211)
      };
    \end{axis}
  \end{tikzpicture}
  \caption{\label{fig:pathological interpolation} Interpolation of a pathological function, $f(x) = \qty(1 + 16x^2)^{-1/2}$, using Chebyshev and equally-spaced Lagrange interpolation schemes.
  Because the Chebyshev scheme clusters sample points in the tails of the interpolation window, it does not suffer from high-order ringing effects (Runge's phenomenon).}
\end{figure}

Given a set of nonuniform sample points, $x_\lambda$, on the interval $\qty[-1, 1]$ where
\begin{equation}
  x_\lambda = -\cos(\frac{\pi (\lambda + 1/2)}{M + 1}) \qquad \lambda = 0, 1, 2, \ldots, M
\end{equation}

\begin{equation}
  c_i = \frac{\alpha_{i}}{M + 1}\sum_{\lambda = 0}^M T_{i}(x_\lambda) f(x_\lambda), \qquad \alpha_i = 2 - \delta_{i0}
\end{equation}

\subsection{Three dimensions}
\begin{equation}
  f(\vb{r}) \approx c_{ijk}T_i(x) T_j(y) T_k(z)
\end{equation}
with an implied summation on the bound indices $i$, $j$, and $k$.
Analogously,
\begin{equation}
  c_{ijk} = \frac{\alpha_{ii'} \alpha_{jj'} \alpha_{kk'}}{\qty(M+1)^3} f(x_\lambda, y_\mu, z_\nu) T_{i'}(x_\lambda) T_{j'}(y_\mu) T_{k'}(z_\nu)
\end{equation}
(where $\alpha_{ab} \equiv 2\delta_{ab} - \delta_{a0}\delta_{0b}$ has become a diagonal tensor to ``balance'' the implied-sum indices) and thus
\begin{equation}
  f(\vb{r}) \approx \qty(\frac{\alpha_{ii'} \alpha_{jj'} \alpha_{kk'}}{\qty(M+1)^3} \qty(f(x_\lambda, y_\mu, z_\nu) T_{i'}(x_\lambda) T_{j'}(y_\mu) T_{k'}(z_\nu))) T_i(x) T_j(y) T_k(z)
\end{equation}
as one, \emph{mondo}, tensor expression.
